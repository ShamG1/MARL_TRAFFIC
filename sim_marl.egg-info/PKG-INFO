Metadata-Version: 2.1
Name: sim-marl
Version: 0.1.0
Summary: A lightweight MARL intersection environment with C++ backend
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: numpy>=1.21.0
Requires-Dist: pillow>=9.0.0

# MARL æ— ä¿¡å·è·¯å£ç¯å¢ƒ ğŸš¦

è¿™æ˜¯ä¸€ä¸ªåŸºäº **C++ (pybind11) + OpenGL/GLFW** çš„è½»é‡çº§å¤šæ™ºèƒ½ä½“å¼ºåŒ–å­¦ä¹  (MARL) æ— ä¿¡å·è·¯å£ä»¿çœŸç¯å¢ƒã€‚

é¡¹ç›®å®ç°äº†åŸºäº **è¿åŠ¨å­¦è‡ªè¡Œè½¦æ¨¡å‹** çš„è½¦è¾†æ§åˆ¶ã€**è´å¡å°”æ›²çº¿** å¯¼èˆªã€**çº¿æŸæ¿€å…‰é›·è¾¾** æ„ŸçŸ¥ä»¥åŠç¬¦åˆå­¦æœ¯æ ‡å‡†çš„ **RL è§‚æµ‹ç©ºé—´**ã€‚

---

## ğŸ“¸ åœºæ™¯å±•ç¤º

<table>
  <tr>
    <td align="center" width="50%">
      <img src="envs/cpp/assets/cross.png" alt="Cross Intersection" width="100%" />
      <br />Intersection
    </td>
    <td align="center" width="50%">
      <img src="envs/cpp/assets/T.png" alt="T Intersection" width="100%" />
      <br />T
    </td>
  </tr>
  <tr>
    <td align="center" width="50%">
      <img src="envs/cpp/assets/roundabout.png" alt="Roundabout" width="100%" />
      <br />Roundabout
    </td>
    <td align="center" width="50%">
      <img src="envs/cpp/assets/highway.png" alt="Highway" width="100%" />
      <br />Highway
    </td>
  </tr>
</table>

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ–‡ä»¶
- `envs/env.py`ï¼šPython ä¾§ç¯å¢ƒå°è£…ï¼ˆå¯¹å¤– APIï¼š`ScenarioEnv`ï¼‰ï¼Œè´Ÿè´£å‚æ•°é…ç½®ã€è°ƒç”¨ C++ åç«¯ã€ç»„ç»‡ obs/reward/info
- `envs/cpp_backend.py`ï¼šPython â†” C++ åç«¯æ¡¥æ¥
- `envs/cpp/`ï¼šC++ åç«¯æºç ï¼ˆpybind11 æ‰©å±•æ¨¡å—ï¼‰ï¼ŒåŒ…å«ä»¿çœŸã€æ¸²æŸ“ï¼ˆOpenGL/GLFWï¼‰ä¸ä¼ æ„Ÿå™¨/äº¤é€šæµé€»è¾‘
- `envs/utils.py`ï¼šè·¯çº¿æ˜ å°„ã€lane layout ç­‰è¾…åŠ©
- `scenarios/`ï¼šåœºæ™¯èµ„æºç›®å½•ã€‚æ¯ä¸ªåœºæ™¯æ–‡ä»¶å¤¹ï¼ˆå¦‚ `cross_2lane/`ï¼‰åŒ…å«ï¼š
  - `drivable.png`ï¼šå¯è¡Œé©¶åŒºåŸŸæ©ç 
  - `yellowline.png`ï¼šé»„çº¿/å®çº¿æ©ç ï¼ˆç”¨äºå‹çº¿ç¢°æ’/æƒ©ç½šï¼‰
  - `lane_dashes.png`ï¼šè™šçº¿æ¸²æŸ“å›¾
  - `lane_id.png`ï¼šè½¦é“ ID å›¾ï¼ˆç”¨äºè½¦é“ç´¢å¼•/è°ƒè¯•ï¼‰

### æµ‹è¯•æ–‡ä»¶
- `test.py`ï¼šé”®ç›˜æ§åˆ¶æµ‹è¯•è„šæœ¬ï¼ˆä¼šè°ƒç”¨ C++ æ¸²æŸ“çª—å£ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

#### æ„å»ºä¾èµ–

- `CMake >= 3.18`
- æ”¯æŒ `C++17` çš„ç¼–è¯‘å™¨ï¼ˆLinux: GCC/Clangï¼›Windows: MSVCï¼‰
- `OpenGL`
- `GLFW`ï¼ˆLinux ä¸‹ CMake ä¼š `find_package(glfw3 3.3 REQUIRED)`ï¼‰
- `PyTorch`ï¼ˆç”¨äºæä¾› C++ ä¾§ `LibTorch`ï¼ŒCMake ä¼šé€šè¿‡ Python è‡ªåŠ¨å®šä½ Torch çš„ CMake é…ç½®ï¼‰

#### 1. ç¼–è¯‘ C++ åç«¯

```bash
cd envs/cpp
mkdir -p build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
# Linux
make -j$(nproc)
# Windows (MSVC)
cmake --build . --config Release
```

#### 2. pip å®‰è£…æœ¬ç¯å¢ƒ (æ¨èå¼€å‘æ¨¡å¼)

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
pip install -e .
```

ä¹Ÿå¯ä»¥ä»…å®‰è£… Python ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

#### 3. è¿è¡Œæµ‹è¯•

```bash
python test.py
```

---

## ğŸ® ä½¿ç”¨æ–¹æ³•

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡ `sim_marl` å¯¼å…¥å¹¶ä½¿ç”¨ç¯å¢ƒï¼š

```python
from sim_marl import ScenarioEnv
import numpy as np

# 1. å‡†å¤‡é…ç½®
config = {
    'scenario_name': 'cross_2lane',  # å¿…å¡«ï¼šåŒ¹é… scenarios/ ä¸‹çš„ç›®å½•å
    'traffic_flow': True,            # True=å•æ™ºèƒ½ä½“+äº¤é€šæµ, False=å¤šæ™ºèƒ½ä½“
    'traffic_density': 0.5,          # äº¤é€šå¯†åº¦
    'render_mode': 'human',          # 'human' æˆ– None
    'show_lidar': False,
    'show_lane_ids': False,
    'max_steps': 2000,
}

# 2. åˆ›å»ºç¯å¢ƒ
env = ScenarioEnv(config)

# 3. è¿è¡Œå¾ªç¯
obs, info = env.reset()
for _ in range(100):
    action = np.array([0.5, 0.0])
    obs, reward, terminated, truncated, info = env.step(action)
    env.render()
    if terminated or truncated:
        obs, info = env.reset()
```

---

## âš™ï¸ ç¯å¢ƒé…ç½®

### å•æ™ºèƒ½ä½“æ¨¡å¼ï¼ˆå¸¦äº¤é€šæµï¼‰

```python
config = {
    'scenario_name': 'cross_2lane',
    'traffic_flow': True,  # å¯ç”¨äº¤é€šæµ
    'traffic_density': 0.5,  # äº¤é€šå¯†åº¦
    'render_mode': 'human',
    'max_steps': 2000,
    'ego_routes': [('IN_6', 'OUT_2')],  # å¯é€‰ï¼šæŒ‡å®š ego è½¦è¾†è·¯çº¿
}
```

### å¤šæ™ºèƒ½ä½“æ¨¡å¼ï¼ˆæ— äº¤é€šæµï¼‰

```python
config = {
    'scenario_name': 'cross_2lane',
    'traffic_flow': False,  # ç¦ç”¨äº¤é€šæµ
    'num_agents': 4,  # æ™ºèƒ½ä½“æ•°é‡
    'use_team_reward': True,  # æ˜¯å¦ä½¿ç”¨å›¢é˜Ÿå¥–åŠ±
    'render_mode': 'human',
    'max_steps': 2000,
}
```

---

## ğŸ¯ å¥–åŠ±å‡½æ•°é…ç½®

å¥–åŠ±å‡½æ•°å·²é›†æˆåœ¨ `envs/env.py` ä¸­ï¼Œå¯ä»¥é€šè¿‡ `reward_config` å‚æ•°è‡ªå®šä¹‰ï¼š

```python
from envs.env import DEFAULT_REWARD_CONFIG

# 1. ä½¿ç”¨é»˜è®¤é…ç½®
config = {
    'reward_config': DEFAULT_REWARD_CONFIG['reward_config']
}

# 2. è‡ªå®šä¹‰å¥–åŠ±é…ç½®
custom_reward_config = {
    'progress_scale': 10.0,             # è¿›åº¦å¥–åŠ±ç³»æ•°
    'stuck_speed_threshold': 1.0,        # å¡ä½é€Ÿåº¦é˜ˆå€¼ (m/s)
    'stuck_penalty': -0.01,              # å¡ä½æƒ©ç½š
    'crash_vehicle_penalty': -10.0,      # è½¦è¾†ç¢°æ’æƒ©ç½š
    'crash_wall_penalty': -5.0,         # æ’å¢™/å†²å‡ºé“è·¯æƒ©ç½š
    'crash_line_penalty': -2.0,         # å‹å®çº¿/é»„çº¿æƒ©ç½š
    'success_reward': 10.0,             # æˆåŠŸåˆ°è¾¾å¥–åŠ±
    'action_smoothness_scale': -0.02,    # åŠ¨ä½œå¹³æ»‘åº¦ç³»æ•°
    'team_alpha': 0.2,                  # å›¢é˜Ÿå¥–åŠ±æ··åˆç³»æ•°ï¼ˆä»…å¤šæ™ºèƒ½ä½“ï¼‰
}

config = {
    'reward_config': custom_reward_config
}
```

### å¥–åŠ±ç»„æˆ

**ä¸ªä½“å¥–åŠ±** (Individual Reward):
```
r_i^ind(t) = r_prog(t) + r_stuck(t) + r_crashV(t) + 
             r_crashW(t) + r_crashL(t) + r_succ(t) + r_smooth(t)
```

**å›¢é˜Ÿå¥–åŠ±** (Team Reward, ä»…å¤šæ™ºèƒ½ä½“æ¨¡å¼):
```
r_i^mix(t) = (1 - Î±) * r_i^ind(t) + Î± * rÌ„^ind(t)
```

å…¶ä¸­ï¼š
- `r_prog`: åŸºäºè·ç¦»å‡å°‘çš„è¿›åº¦å¥–åŠ±ï¼ˆå½’ä¸€åŒ–åä¹˜ä»¥ `progress_scale`ï¼‰
- `r_stuck`: é€Ÿåº¦è¿‡ä½æ—¶çš„å¡ä½æƒ©ç½šï¼ˆæ¯æ­¥ï¼‰
- `r_crashV`: è½¦è¾†ç¢°æ’æƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼‰
- `r_crashW`: æ’å¢™/ç¦»å¼€é“è·¯æƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼Œé€šè¿‡ `CRASH_WALL` è§¦å‘ï¼‰
- `r_crashL`: å‹é»„çº¿/å®çº¿æƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼Œé€šè¿‡ `CRASH_LINE` è§¦å‘ï¼‰
- `r_succ`: æˆåŠŸåˆ°è¾¾ç›®æ ‡ç‚¹çš„å¥–åŠ±ï¼ˆä¸€æ¬¡æ€§ï¼‰
- `r_smooth`: åŠ¨ä½œå¹³æ»‘åº¦å¥–åŠ±ï¼ˆåŸºäºåŠ é€Ÿåº¦/è½¬å‘å˜åŒ–ï¼Œæ¯æ­¥ï¼‰

---

## ğŸš— äº¤é€šæµè®¾ç½®

### äº¤é€šå¯†åº¦

`traffic_density` å‚æ•°æ§åˆ¶ NPC è½¦è¾†çš„ç”Ÿæˆé¢‘ç‡ï¼š

```python
config = {
    'traffic_flow': True,
    'traffic_density': 0.5,  # èŒƒå›´ [0, 1]ï¼Œ0.5 è¡¨ç¤ºä¸­ç­‰å¯†åº¦
}
```

### NPC è½¦è¾†è¡Œä¸º

NPC è½¦è¾†é€šè¿‡ C++ åç«¯é©±åŠ¨ï¼š
- **æ¨ªå‘æ§åˆ¶**ï¼šåŸºäºè·¯å¾„çš„ PID èˆªå‘è·Ÿè¸ªã€‚
- **çºµå‘æ§åˆ¶**ï¼šIDM (Intelligent Driver Model) æˆ– ACC å·¡èˆªï¼Œå…·å¤‡è‡ªåŠ¨é¿éšœã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šNPC ä¹‹é—´å‘ç”Ÿç¢°æ’æˆ–åˆ°è¾¾ç›®çš„åœ°åä¼šè‡ªåŠ¨ç§»é™¤ã€‚

---

## ğŸ“ TODO

- [x] é›†æˆå¥–åŠ±è®¡ç®—åˆ°ç¯å¢ƒ
- [x] é›†æˆäº¤é€šæµç”Ÿæˆåˆ°ç¯å¢ƒ
- [x] æ”¯æŒå•æ™ºèƒ½ä½“å’Œå¤šæ™ºèƒ½ä½“æ¨¡å¼
- [x] æ”¯æŒå¤šåœ°å›¾æµ‹è¯•

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª MIT Licenseã€‚
